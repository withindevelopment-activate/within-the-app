{% extends "Demo/base.html" %}

{% block title %} Marketing {% endblock title %}

{% block content %}
<div class="container py-4">
    <h2 class="mb-4">رفع ملفات السوشل ميديا</h2>
    <form id="marketing-report-form" enctype="multipart/form-data">
        <!-- Date Selection -->
        <div class="date-selection">
            <label for="start_time">Start Date:</label>
            <input type="date" id="start_time" name="start_time" required>
            
            <label for="end_time">End Date:</label>
            <input type="date" id="end_time" name="end_time" required>
        </div><br><br>

        <!-- File Uploads -->
        <div class="file-upload-form">
            <label for="file1">Facebook File:</label>
            <input type="file" id="file1" name="file1" accept=".xlsx" required>
        </div>
        
        <div class="file-upload-form">
            <label for="file2">Tiktok File:</label>
            <input type="file" id="file2" name="file2" accept=".xlsx" required>
        </div>
        
        <div class="file-upload-form">
            <label for="file3">Snapchat File:</label>
            <input type="file" id="file3" name="file3" accept=".xlsx" required>
        </div>
        
        <div class="file-upload-form">
            <label for="file4">Google ADS File:</label>
            <input type="file" id="file4" name="file4" accept=".xlsx" required>
        </div>
        
        <div class="file-upload-form">
            <label for="file5">Zid File:</label>
            <input type="file" id="file5" name="file5" accept=".xlsx" required>
        </div>

        <div class="file-upload-form">
            <label for="file6">Google Analytics File:</label>
            <input type="file" id="file6" name="file6" accept=".xlsx" required>
        </div>
        
        <!-- Submit all button -->
        <button type="submit" id="global-submit" class="btn btn-primary">Submit</button>
    </form>

{% if sheets %}
  <ul class="nav nav-tabs" id="myTab" role="tablist">
    {% for sheet, data in sheets.items %}
      <li class="nav-item">
        <button class="nav-link {% if forloop.first %}active{% endif %}" 
                data-bs-toggle="tab" data-bs-target="#{{ data.safe_name }}">
          {{ data.safe_name }}
        </button>
      </li>
    {% endfor %}
  </ul>

   <!-- Tab Content -->
  <div class="tab-content mt-3">
    {% for sheet, data in sheets.items %}
      <div class="tab-pane fade {% if forloop.first %}show active{% endif %}" id="{{ data.safe_name }}">
        
        <!-- Table Section -->
        <div class="data-wrap">
            <div class="data-viewport">
                <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
                    <table class="data-table" role="table" aria-label="Analytics dataset">
                        <thead>
                            <tr>
                                {% for col in data.columns %}
                                <th>{{ col }}</th>
                                {% endfor %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data.rows %}
                            <tr>
                                {% for cell in row %}
                                <td>{{ cell }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Include the Charts file -->
        {% include "charts.html" with data=data %}

      </div>
    {% endfor %}
  </div>
{% endif %}
</div>

<script>
    // The script for the AJAX call for the marketing report
    $('#marketing-report-form').on('submit', function (event) {
        event.preventDefault();

        let allFilesSelected = true;
        let missingFileForm = null;

        $('.file-upload-form').each(function () {
            const fileInput = $(this).find('input[type="file"]');
            if (!fileInput[0].files.length) {
                allFilesSelected = false;
                missingFileForm = $(this);
                return false;
            }
        });

        if (!allFilesSelected) {
            const formId = missingFileForm.find('input[type="file"]').attr('name');
            alert(`Form with ID ${formId} does not have a file uploaded.`);
            return;
        }

        const startTime = $('#start_time').val();
        const endTime = $('#end_time').val();

        if (!startTime || !endTime) {
            alert("Please select both start and end dates.");
            return;
        }

        const formData = new FormData(this);
        formData.append("start_time", startTime);
        formData.append("end_time", endTime);

        $.ajax({
            url: "{% url 'Demo:process_marketing_report' %}",
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function (response) {
                window.location.href = response.download_url;
            },
            error: function (xhr, status, error) {
                alert(`Error uploading files: ${xhr.responseText}`);
            }
        });
    });
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

{% endblock %}
