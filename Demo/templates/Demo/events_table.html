{% extends 'Demo/base.html' %}
{% load static %}

{% block content %}

<div class="container mt-4">
    <h3 class="mb-4">Tracking Events Viewer</h3>

    <!-- Filters Form -->
    <form method="GET" class="row g-3 mb-4">

        <!-- Event Type -->
        <div class="col-md-3">
            <label class="form-label">Event Type</label>
            <select name="event_type" class="form-select">
                <option value="">All</option>
                <option value="purchase" {% if selected_event_type == "purchase" %}selected{% endif %}>Purchase</option>
                <option value="add_to_cart" {% if selected_event_type == "add_to_cart" %}selected{% endif %}>Add to Cart</option>
                <option value="pageview" {% if selected_event_type == "pageview" %}selected{% endif %}>Pageview</option>
            </select>
        </div>

        <!-- Limit -->
        <div class="col-md-2">
            <label class="form-label">Limit</label>
            <select name="limit" class="form-select">
                <option value="50" {% if selected_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if selected_limit == 100 %}selected{% endif %}>100</option>
            </select>
        </div>

        <!-- Date After -->
        <div class="col-md-3">
            <label class="form-label">Date After</label>
            <input type="datetime-local" name="date_after" value="{{ selected_date }}" class="form-control">
        </div>

        <!-- Search Session ID -->
        <div class="col-md-2">
            <label class="form-label">Session ID</label>
            <input type="text" name="session_id" value="{{ session_search }}" class="form-control">
        </div>

        <!-- Search Visitor ID -->
        <div class="col-md-2">
            <label class="form-label">Visitor ID</label>
            <input type="text" name="visitor_id" value="{{ visitor_search }}" class="form-control">
        </div>

        <!-- Sorting -->
        <div class="col-md-2">
            <label class="form-label">Sort By</label>
            <select name="sort_by" class="form-select">
                <option value="Distinct_ID">Distinct_ID</option>
                <option value="Session_ID" {% if request.GET.sort_by == "Session_ID" %}selected{% endif %}>Session ID</option>
                <option value="Visitor_ID" {% if request.GET.sort_by == "Visitor_ID" %}selected{% endif %}>Visitor ID</option>
            </select>
        </div>

        <div class="col-md-12 text-end">
            <button class="btn btn-primary">Apply Filters</button>
        </div>
    </form>

    <div class="row mb-5">
        <div class="col-md-6">
            <h5 class="text-center">UTM Source Distribution (%)</h5>
            <canvas id="utmSourceChart"></canvas>
        </div>

        <div class="col-md-6">
            <h5 class="text-center">UTM Campaign Distribution (%)</h5>
            <canvas id="utmCampaignChart"></canvas>
        </div>
    </div>

    <!-- Data Table -->
    <div class="data-wrap">
        <div class="data-viewport">
            <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            {% if data %}
                                {% for col in data.0.keys %}
                                    <th>{{ col }}</th>
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                            <tr>
                                {% for val in row.values %}
                                    <td>{{ val }}</td>
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="20" class="text-center">No data found.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    const modernColors = [
    '#6366F1','#F59E0B','#10B981','#EF4444','#3B82F6',
    '#8B5CF6','#EC4899','#14B8A6','#F97316','#84CC16',
    "#3366CC","#DC3912","#FF9900","#109618","#990099",
    "#0099C6","#DD4477","#66AA00","#B82E2E","#316395",
    "#994499","#22AA99"
    ];

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 20 }
    };
    const utmSourceData = {
        labels: {{ utm_source_labels|safe }},
        datasets: [{
            data: {{ utm_source_values|safe }},
            backgroundColor: modernColors,
            hoverOffset: 20,
            borderWidth: 0,
            borderRadius: 10,
            spacing: 0,
            radius: '80%',
        }]
    };

    const utmCampaignData = {
        labels: {{ utm_campaign_labels|safe }},
        datasets: [{
            data: {{ utm_campaign_values|safe }},
            backgroundColor: modernColors,
            hoverOffset: 20,
            borderWidth: 0,
            borderRadius: 10,
            spacing: 0,
            radius: '80%',
        }]
    };

    const pieOptions = {
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                    }
                }
            },
            legend: {
                position: 'bottom'
            }
        }
    };

    if (utmSourceData.labels.length) {
        new Chart(document.getElementById('utmSourceChart'), {
            type: 'pie',
            data: utmSourceData,
            options: pieOptions
        });
    }

    if (utmCampaignData.labels.length) {
        new Chart(document.getElementById('utmCampaignChart'), {
            type: 'pie',
            data: utmCampaignData,
            options: pieOptions
        });
    }
</script>


{% endblock %}
