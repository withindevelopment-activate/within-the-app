{% extends 'Demo/base.html' %}
{% load static %}

{% block content %}

<div class="container mt-4">
    <h3 class="mb-4">Tracking Events Viewer</h3>

    <!-- Filters Form -->
    <form method="GET" class="row g-3 mb-4">

        <!-- Event Type -->
        <div class="col-md-3">
            <label class="form-label">Event Type</label>
            <select name="event_type" class="form-select">
                <option value="">All</option>
                <option value="purchase" {% if selected_event_type == "purchase" %}selected{% endif %}>Purchase</option>
                <option value="add_to_cart" {% if selected_event_type == "add_to_cart" %}selected{% endif %}>Add to Cart</option>
                <option value="pageview" {% if selected_event_type == "pageview" %}selected{% endif %}>Pageview</option>
            </select>
        </div>

        <!-- Limit -->
        <div class="col-md-2">
            <label class="form-label">Limit</label>
            <select name="limit" class="form-select">
                <option value="50" {% if selected_limit == 50 %}selected{% endif %}>50</option>
                <option value="100" {% if selected_limit == 100 %}selected{% endif %}>100</option>
                <option value="500" {% if selected_limit == 500 %}selected{% endif %}>500</option>
                <option value="1000" {% if selected_limit == 1000 %}selected{% endif %}>1000</option>
                <option value="2500" {% if selected_limit == 2500 %}selected{% endif %}>2500</option>
            </select>
        </div>

        <!-- Date After -->
        <div class="col-md-3">
            <label class="form-label">Date After</label>
            <input type="datetime-local" name="date_after" value="{{ selected_date }}" class="form-control">
        </div>

        <div class="col-md-3">
            <label class="form-label">Date Before</label>
            <input type="datetime-local" name="date_end" value="{{ selected_date_end }}" class="form-control">
        </div>

        <!-- Search Session ID -->
        <div class="col-md-2">
            <label class="form-label">Session ID</label>
            <input type="text" name="session_id" value="{{ session_search }}" class="form-control">
        </div>

        <!-- Search Visitor ID -->
        <div class="col-md-2">
            <label class="form-label">Visitor ID</label>
            <input type="text" name="visitor_id" value="{{ visitor_search }}" class="form-control">
        </div>

        <div class="col-md-2">
            <label class="form-label">Timezone</label>
            <input type="text" name="timezone" value="{{ timezone_search }}" class="form-control">
        </div>

        <!-- Sorting -->
        <div class="col-md-2">
            <label class="form-label">Sort By</label>
            <select name="sort_by" class="form-select">
                <option value="Distinct_ID">Distinct_ID</option>
                <option value="Session_ID" {% if request.GET.sort_by == "Session_ID" %}selected{% endif %}>Session ID</option>
                <option value="Visitor_ID" {% if request.GET.sort_by == "Visitor_ID" %}selected{% endif %}>Visitor ID</option>
            </select>
        </div>

        <div class="col-md-12 d-flex justify-content-end gap-2">
            <button type="submit"
                    class="btn btn-primary"
                    onclick="document.getElementById('action-field').value='filter'">
                Apply Filters
            </button>

            <button type="submit"
                    class="btn btn-outline-success"
                    onclick="document.getElementById('action-field').value='export_excel'">
                Export Excel
            </button>

            <button type="submit"
                    class="btn btn-outline-warning"
                    onclick="return confirm('Update database using current filters?') &&
                            (document.getElementById('action-field').value='update_db')">
                Update Database
            </button>
        </div>
        <input type="hidden" name="action" id="action-field">
    </form>

    <div class="row mb-5">
        <div class="col-md-6">
            <h5 class="text-center">UTM Source Distribution (%)</h5>
            <div class="chart-wrapper">
                <canvas id="utmSourceChart"></canvas>
            </div>
            <div class="chartjs-legend-wrapper" id="utmSourceLegend"></div>
        </div>

        <div class="col-md-6">
            <h5 class="text-center">UTM Campaign Distribution (%)</h5>
            <div class="chart-wrapper">
                <canvas id="utmCampaignChart"></canvas>
            </div>
            <div class="chartjs-legend-wrapper" id="utmCampaignLegend"></div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="data-wrap">
        <div class="data-viewport">
            <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
                <table class="data-table" role="table" aria-label="Analytics dataset">
                    <thead>
                        <tr>
                            {% if data %}
                                {% for col in data.0.keys %}
                                    <th>{{ col }}</th>
                                {% endfor %}
                            {% endif %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in data %}
                            <tr>
                                {% for val in row.values %}
                                    <td>{{ val }}</td>
                                {% endfor %}
                            </tr>
                        {% empty %}
                            <tr>
                                <td colspan="20" class="text-center">No data found.</td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!--
<div class="container mt-4" style="max-width: 600px;">
    <h4>WATI Template Manual Test</h4>

    <form method="post" class="card p-3 mt-3">
        {% csrf_token %}

        <div class="mb-3">
            <label class="form-label">Phone (E.164, no +)</label>
            <input type="text" name="phone" class="form-control" placeholder="9715XXXXXXXX" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Customer Name</label>
            <input type="text" name="customer_name" class="form-control" required>
        </div>

        <div class="mb-3">
            <label class="form-label">Checkout URL</label>
            <input type="text" name="checkout_url" class="form-control" required>
        </div>

        <button type="submit" class="btn btn-primary w-100">
            Send WATI Template
        </button>
    </form>

    {% if result %}
        <div class="alert alert-success mt-3">
            <strong>Response:</strong>
            <pre>{{ result|safe }}</pre>
        </div>
    {% endif %}

    {% if error %}
        <div class="alert alert-danger mt-3">
            {{ error }}
        </div>
    {% endif %}
</div> -->

<script>
    const htmlLegendPlugin = {
        id: 'htmlLegend',
        afterUpdate(chart, args, options) {
            const container = document.getElementById(options.containerID);
            let ul = container.querySelector('ul');

            if (!ul) {
                ul = document.createElement('ul');
                ul.style.listStyle = 'none';
                ul.style.padding = 0;
                ul.style.margin = 0;
                container.appendChild(ul);
            }

            // Clear old legend items
            while (ul.firstChild) {
                ul.firstChild.remove();
            }

            chart.data.labels.forEach((label, i) => {
                const li = document.createElement('li');
                li.style.display = 'flex';
                li.style.alignItems = 'center';
                li.style.cursor = 'pointer';
                li.style.transition = 'opacity 0.2s';

                const box = document.createElement('span');
                box.style.background = chart.data.datasets[0].backgroundColor[i];
                box.style.width = '12px';
                box.style.height = '12px';
                box.style.marginRight = '8px';
                box.style.borderRadius = '3px';

                li.appendChild(box);
                li.appendChild(document.createTextNode(label));
                ul.appendChild(li);

                // ---------------------------
                // Hover: highlight slice
                // ---------------------------
                li.addEventListener('mouseenter', () => {
                    chart.setActiveElements([{datasetIndex: 0, index: i}]);
                    chart.tooltip.setActiveElements([{datasetIndex: 0, index: i}], {x:0,y:0});
                    chart.update();
                });
                li.addEventListener('mouseleave', () => {
                    chart.setActiveElements([]);
                    chart.tooltip.setActiveElements([]);
                    chart.update();
                });

                // ---------------------------
                // Click: toggle slice visibility
                // ---------------------------
                li.addEventListener('click', () => {
                    const meta = chart.getDatasetMeta(0);
                    const slice = meta.data[i];
                    slice.hidden = !slice.hidden;
                    li.style.opacity = slice.hidden ? 0.5 : 1; // dim hidden slices
                    chart.update();
                });

                // Set initial opacity if slice is hidden
                const meta = chart.getDatasetMeta(0);
                const slice = meta.data[i];
                li.style.opacity = slice?.hidden ? 0.5 : 1;
            });
        }
    };

    const modernColors = [
    '#6366F1','#F59E0B','#10B981','#EF4444','#3B82F6',
    '#8B5CF6','#EC4899','#14B8A6','#F97316','#84CC16',
    "#3366CC","#DC3912","#FF9900","#109618","#990099",
    "#0099C6","#DD4477","#66AA00","#B82E2E","#316395",
    "#994499","#22AA99"
    ];

    const chartOptions = {
        responsive: true,
        maintainAspectRatio: false,
        layout: { padding: 20 }
    };
    const utmSourceData = {
        labels: {{ utm_source_labels|safe }},
        datasets: [{
            data: {{ utm_source_values|safe }},
            backgroundColor: modernColors,
            hoverOffset: 20,
            borderWidth: 0,
            borderRadius: 10,
            spacing: 0,
            radius: '80%',
        }]
    };

    const utmCampaignData = {
        labels: {{ utm_campaign_labels|safe }},
        datasets: [{
            data: {{ utm_campaign_values|safe }},
            backgroundColor: modernColors,
            hoverOffset: 20,
            borderWidth: 0,
            borderRadius: 10,
            spacing: 0,
            radius: '80%',
        }]
    };

    const pieOptions = {
        plugins: {
            tooltip: {
                callbacks: {
                    label: function(context) {
                        return context.label + ': ' + context.parsed + '%';
                    }
                }
            },
            legend: {
                display: false
            }
        }
    };

    if (utmSourceData.labels.length) {
        new Chart(document.getElementById('utmSourceChart'), {
            type: 'pie',
            data: utmSourceData,
            options: pieOptions,
            plugins: [{
                ...htmlLegendPlugin,
                containerID: 'utmSourceLegend'
            }]
        });
    }
    
    if (utmCampaignData.labels.length) {
        new Chart(document.getElementById('utmCampaignChart'), {
            type: 'pie',
            data: utmCampaignData,
            options: pieOptions,
            plugins: [{
                ...htmlLegendPlugin,
                containerID: 'utmCampaignLegend'
            }]
        });
    }
</script>


{% endblock %}
