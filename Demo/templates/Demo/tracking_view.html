{% extends "Demo/base.html" %}

{% block title %} Tracking {% endblock title %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Tracking Overview (Store {{ track_id }})</h2>

  <!-- Summary Cards -->
  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Visitors</h5>
          <h3>{{ total_visitors }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Unique Sessions</h5>
          <h3>{{ total_sessions }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Pageviews</h5>
          <h3>{{ total_pageviews }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="mb-4 row">
    <div class="col-md-3">
      <input type="text" class="form-control" name="visitor" placeholder="Visitor ID" value="{{ request.GET.visitor }}">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" name="session" placeholder="Session ID" value="{{ request.GET.session }}">
    </div>
    <div class="col-md-3">
      <input type="date" class="form-control" name="from" value="{{ request.GET.from }}">
    </div>
    <div class="col-md-3">
      <input type="date" class="form-control" name="to" value="{{ request.GET.to }}">
    </div>
    <div class="col-md-12 mt-2">
      <button class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- Tracking Table -->

  <div class="row mt-5">
    <!-- Campaign Chart -->
    <div class="col-md-6">
      <h5 class="text-center mb-2">Conversions by Campaign</h5>
      <div class="d-flex">
        <div style="flex: 1; height: 400px;">
          <canvas id="campaignPieChart"></canvas>
        </div>
        <div id="campaignLegend" class="ms-3" style="overflow-y:auto; max-height:400px;"></div>
      </div>
    </div>

    <!-- Source Chart -->
    <div class="col-md-6">
      <h5 class="text-center mb-2">Conversions by UTM Source</h5>
      <div class="d-flex">
        <div style="flex: 1; height: 400px;">
          <canvas id="sourcePieChart"></canvas>
        </div>
        <div id="sourceLegend" class="ms-3" style="overflow-y:auto; max-height:400px;"></div>
      </div>
    </div>
  </div>


<div class="mt-5">
  <h4>Customer Dictionary</h4>
  <div class="data-wrap">
    <div class="data-viewport">
      <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
        <table class="data-table" role="table" aria-label="Tracking dataset">
          <thead>
            <tr>
              <th>Visitor IDs</th>
              <th>Session IDs</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Campaigns</th>
              <th>Add to Cart</th>
              <th>Purchases</th>
            </tr>
          </thead>
          <tbody>
            {% for key, c in customer_dict.items %}
            <tr>
              <td>{{ key }}</td>
              <td>{{ c.session_ids|join:", " }}</td>
              <td>{{ c.customer_name }}</td>
              <td>{{ c.customer_email }}</td>
              <td>{{ c.customer_phone }}</td>
              <td>{{ c.campaigns|join:", " }}</td>
              <td>{{ c.add_to_cart }}</td>
              <td>{{ c.purchases }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No customer data found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
<!--
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const modernColors = [
    '#6366F1','#F59E0B','#10B981','#EF4444','#3B82F6',
    '#8B5CF6','#EC4899','#14B8A6','#F97316','#84CC16',
    "#3366CC", "#DC3912", "#FF9900", "#109618", "#990099", 
    "#0099C6", "#DD4477", "#66AA00", "#B82E2E", "#316395", 
    "#994499", "#22AA99"
  ];

  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { legend: { display: false } },
    layout: { padding: 20 }
  };

  function generateLegend(chart, legendContainerId) {
    const container = document.getElementById(legendContainerId);
    container.innerHTML = '';

    const ul = document.createElement('ul');
    ul.style.padding = 0;
    ul.style.margin = 0;

    chart.data.labels.forEach((label, i) => {
      const li = document.createElement('li');
      li.style.display = 'flex';
      li.style.alignItems = 'center';
      li.style.cursor = 'pointer';
      li.style.marginBottom = '6px';
      li.dataset.index = i;

      const box = document.createElement('span');
      box.style.display = 'inline-block';
      box.style.width = '12px';
      box.style.height = '12px';
      box.style.borderRadius = '6px';
      box.style.backgroundColor = chart.data.datasets[0].backgroundColor[i];
      box.style.marginRight = '6px';

      const text = document.createElement('span');
      text.textContent = label + " (" + chart.data.datasets[0].data[i] + ")";
      
      li.appendChild(box);
      li.appendChild(text);

      li.addEventListener('click', function() {
        const index = this.dataset.index;
        const meta = chart.getDatasetMeta(0);
        const slice = meta.data[index];

        // Toggle visibility
        slice.hidden = !slice.hidden;

        // Line-through disabled slices
        text.style.textDecoration = slice.hidden ? 'line-through' : 'none';
        chart.update();
      });

      ul.appendChild(li);
    });

    container.appendChild(ul);
  }

  // Campaign Pie
  const campaignPieChart = new Chart(document.getElementById('campaignPieChart'), {
    type: 'pie',
    data: {
      labels: {{ campaign_labels|safe }},
      datasets: [{
        data: {{ campaign_data|safe }},
        backgroundColor: modernColors,
        hoverOffset: 20,
        borderWidth: 0,
        borderRadius: 10,
        spacing: 2,
        radius: '80%',
      }]
    },
    options: chartOptions,
  });
  generateLegend(campaignPieChart, 'campaignLegend');

  // Source Pie
  const sourcePieChart = new Chart(document.getElementById('sourcePieChart'), {
    type: 'pie',
    data: {
      labels: {{ source_labels|safe }},
      datasets: [{
        data: {{ source_data|safe }},
        backgroundColor: modernColors,
        hoverOffset: 20,
        borderWidth: 0,
        borderRadius: 10,
        spacing: 2,
        radius: '80%',
      }]
    },
    options: chartOptions,
  });
  generateLegend(sourcePieChart, 'sourceLegend');
  </script>
-->
</div>
{% endblock %}
