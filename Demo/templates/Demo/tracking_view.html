{% extends "Demo/base.html" %}

{% block title %} Tracking {% endblock title %}

{% block content %}
<div class="container py-4">
  <h2 class="mb-4">Tracking Overview (Store {{ track_id }})</h2>

  <!-- Summary Cards -->
  <div class="row text-center mb-4">
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Visitors</h5>
          <h3>{{ total_visitors }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Unique Sessions</h5>
          <h3>{{ total_sessions }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Last 30min Pageviews</h5>
          <h3>{{ total_pageviews }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <form method="get" class="mb-4 row">
    <div class="col-md-3">
      <input type="text" class="form-control" name="visitor" placeholder="Visitor ID" value="{{ request.GET.visitor }}">
    </div>
    <div class="col-md-3">
      <input type="text" class="form-control" name="session" placeholder="Session ID" value="{{ request.GET.session }}">
    </div>
    <div class="col-md-3">
      <input type="date" class="form-control" name="from" value="{{ request.GET.from }}">
    </div>
    <div class="col-md-3">
      <input type="date" class="form-control" name="to" value="{{ request.GET.to }}">
    </div>
    <div class="col-md-12 mt-2">
      <button class="btn btn-primary w-100">Apply</button>
    </div>
  </form>

  <!-- Tracking Table -->
  <div class="data-wrap">
    <div class="data-viewport">
      <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
        <table class="data-table" role="table" aria-label="Tracking dataset">
          <thead>
            <tr>
              <th>Distinct ID</th>
              <th class="sticky-col">Visitor ID</th>
              <th>Session ID</th>
              <th>Store URL</th>
              <th>Event Type</th>
              <th>Event Details</th>
              <th>Page URL</th>
              <th>Visited At</th>
              <th>UTM Source</th>
              <th>UTM Medium</th>
              <th>UTM Campaign</th>
              <th>UTM Term</th>
              <th>UTM Content</th>
              <th>Referrer</th>
              <th>Traffic Source</th>
              <th>Traffic Medium</th>
              <th>Traffic Campaign</th>
              <th>Customer ID</th>
              <th>Customer Name</th>
              <th>Customer Email</th>
              <th>Customer Mobile</th>
              <th>User Agent</th>
              <th>Language</th>
              <th>Timezone</th>
              <th>Platform</th>
              <th>Screen Resolution</th>
              <th>Device Memory</th>
              <th>IP Address</th>
            </tr>
          </thead>
          <tbody>
            {% for r in rows %}
            <tr>
              <td>{{ r.Distinct_ID }}</td>
              <td class="sticky-col">{{ r.Visitor_ID }}</td>
              <td>{{ r.Session_ID }}</td>
              <td>{{ r.Store_URL }}</td>
              <td>{{ r.Event_Type }}</td>
              <td>{{ r.Event_Details }}</td>
              <td>{{ r.Page_URL }}</td>
              <td>{{ r.Visited_at }}</td>
              <td>{{ r.UTM_Source }}</td>
              <td>{{ r.UTM_Medium }}</td>
              <td>{{ r.UTM_Campaign }}</td>
              <td>{{ r.UTM_Term }}</td>
              <td>{{ r.UTM_Content }}</td>
              <td>{{ r.Referrer_Platform }}</td>
              <td>{{ r.Traffic_Source }}</td>
              <td>{{ r.Traffic_Medium }}</td>
              <td>{{ r.Traffic_Campaign }}</td>
              <td>{{ r.Customer_ID }}</td>
              <td>{{ r.Customer_Name }}</td>
              <td>{{ r.Customer_Email }}</td>
              <td>{{ r.Customer_Mobile }}</td>
              <td>{{ r.User_Agent }}</td>
              <td>{{ r.Language }}</td>
              <td>{{ r.Timezone }}</td>
              <td>{{ r.Platform }}</td>
              <td>{{ r.Screen_Resolution }}</td>
              <td>{{ r.Device_Memory }}</td>
              <td>{{ r.IP_Address }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="28" class="text-center text-muted">No tracking data found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="row mt-5">
    <div class="col-md-6 d-flex">
      <div style="flex: 1; height: 400px;">
        <canvas id="campaignPieChart"></canvas>
      </div>
      <div id="campaignLegend" class="ms-3" style="overflow-y:auto; max-height:400px;"></div>
    </div>

    <div class="col-md-6 d-flex">
      <div style="flex: 1; height: 400px;">
        <canvas id="sourcePieChart"></canvas>
      </div>
      <div id="sourceLegend" class="ms-3" style="overflow-y:auto; max-height:400px;"></div>
    </div>
  </div>


<div class="mt-5">
  <h4>Customer Dictionary</h4>
  <div class="data-wrap">
    <div class="data-viewport">
      <div class="data-scroller" role="region" aria-label="Scrollable data table" tabindex="0">
        <table class="data-table" role="table" aria-label="Tracking dataset">
          <thead>
            <tr>
              <th>Customer Key</th>
              <th>Name</th>
              <th>Email</th>
              <th>Mobile</th>
              <th>Visitor IDs</th>
              <th>Session IDs</th>
              <th>Campaigns</th>
              <th>pageviews</th>
              <th>Add to Cart</th>
              <th>Purchases</th>
            </tr>
          </thead>
          <tbody>
            {% for key, c in customer_dict.items %}
            <tr>
              <td>{{ key }}</td>
              <td>{{ c.user_info.name }}</td>
              <td>{{ c.user_info.email }}</td>
              <td>{{ c.user_info.mobile }}</td>
              <td>{{ c.visitor_ids|join:", " }}</td>
              <td>{{ c.sessions|join:", " }}</td>
              <td>{{ c.campaigns|join:", " }}</td>
              <td>{{ c.stats.pageviews }}</td>
              <td>{{ c.stats.add_to_cart }}</td>
              <td>{{ c.stats.purchases }}</td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="7" class="text-center text-muted">No customer data found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
  const modernColors = [
    '#6366F1','#F59E0B','#10B981','#EF4444','#3B82F6',
    '#8B5CF6','#EC4899','#14B8A6','#F97316','#84CC16',
    "#3366CC", "#DC3912", "#FF9900", "#109618", "#990099", 
    "#0099C6", "#DD4477", "#66AA00", "#B82E2E", "#316395", 
    "#994499", "#22AA99"
  ];

  // Shared chart options
  const chartOptions = {
    responsive: true,
    maintainAspectRatio: false,
    plugins: {
      legend: {
        display: false, // disable built-in legend
      },
    },
    layout: {
      padding: 20
    }
  };

  // --- Campaign Pie ---
  const campaignPieChart = new Chart(document.getElementById('campaignPieChart'), {
    type: 'pie',
    data: {
      labels: {{ campaign_labels|safe }},
      datasets: [{
        data: {{ campaign_data|safe }},
        backgroundColor: modernColors,
        hoverOffset: 20,
        borderWidth: 0,
        borderRadius: 10, 
        spacing: 2,
        radius: '80%',
      }]
    },
    options: chartOptions,
  });

  // Generate separate legend for campaign chart
  document.getElementById('campaignLegend').innerHTML = campaignPieChart.generateLegend();
  campaignPieChart.options.plugins.legend.labels.generateLabels = function(chart) {
    return chart.data.labels.map((label, i) => ({
      text: label + " (" + chart.data.datasets[0].data[i] + ")",
      fillStyle: chart.data.datasets[0].backgroundColor[i],
      strokeStyle: chart.data.datasets[0].backgroundColor[i],
      hidden: false,
      index: i
    }));
  };

  // --- Source Pie ---
  const sourcePieChart = new Chart(document.getElementById('sourcePieChart'), {
    type: 'pie',
    data: {
      labels: {{ source_labels|safe }},
      datasets: [{
        data: {{ source_data|safe }},
        backgroundColor: modernColors,
        hoverOffset: 20,
        borderWidth: 0,
        borderRadius: 10, 
        spacing: 2,
        radius: '80%',
      }]
    },
    options: chartOptions,
  });

  // Generate separate legend for source chart
  document.getElementById('sourceLegend').innerHTML = sourcePieChart.generateLegend();
  sourcePieChart.options.plugins.legend.labels.generateLabels = campaignPieChart.options.plugins.legend.labels.generateLabels;
  </script>


</div>
{% endblock %}
